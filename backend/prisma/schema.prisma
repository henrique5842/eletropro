// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String        @id @default(uuid())
  name                   String
  email                  String        @unique
  password               String
  avatar                 String?
  phone                  String?
  cnpj                   String?
  companyName            String?
  professionalFullName   String?
  verificationCode       String?
  verificationCodeExpires DateTime?
  resetCode              String?
  resetCodeExpires       DateTime?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relacionamentos
  clients                Client[]
  services               Service[]
  materials              Material[]
  budgets                Budget[]
  materialLists          MaterialList[]

  @@map("users")
}

model Client {
  id              String         @id @default(uuid())
  fullName        String
  phone           String
  email           String?
  cpfCnpj         String?
  requiresInvoice Boolean        @default(false)
  publicLink      String?        @unique
  accessCode      String?        @unique
  isActive        Boolean        @default(true)
  cep             String
  street          String
  number          String
  neighborhood    String
  city            String
  state           String
  totalValue      Float          @default(0)
  clientSince     DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relacionamentos
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgets         Budget[]
  materialLists   MaterialList[]

  @@map("clients")
}

model Service {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  unit        ServiceUnit
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgetItems BudgetItem[]

  @@map("services")
}

model Material {
  id        String   @id @default(uuid())
  name      String
  category  String
  price     Float
  unit      MaterialUnit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  userId               String
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgetItems          BudgetItem[]
  materialListItems    MaterialListItem[]

  @@map("materials")
}

model Budget {
  id              String       @id @default(uuid())
  name            String
  clientId        String
  status          BudgetStatus @default(PENDING)
  subtotal        Float?
  discount        Float?       @default(0)
  discountType    DiscountType?
  discountReason  String?
  totalValue      Float?
  validUntil      DateTime?
  notes           String?
  accessLink      String?      @unique
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Campos para aprovação/rejeição
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  clientNotes     String?

  // Relacionamentos
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items           BudgetItem[]
  materialLists   MaterialList[]

  @@map("budgets")
}

model BudgetItem {
  id          String  @id @default(uuid())
  name        String
  description String?
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  unit        String?
  createdAt   DateTime @default(now())  // ← ADICIONE ESTE CAMPO
  updatedAt   DateTime @updatedAt       // ← ADICIONE ESTE CAMPO


  // Relacionamentos
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  serviceId   String?
  service     Service? @relation(fields: [serviceId], references: [id])
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])

  @@map("budget_items")
}

model MaterialList {
  id          String             @id @default(uuid())
  name        String
  clientId    String
  budgetId    String?
  status      MaterialListStatus @default(PENDING)
  totalValue  Float?
  accessLink  String?            @unique
  notes       String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Campos para aprovação/rejeição
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  clientNotes     String?

  // Relacionamentos
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  budget          Budget?           @relation(fields: [budgetId], references: [id])
  items           MaterialListItem[]

  @@map("material_lists")
}

model MaterialListItem {
  id             String  @id @default(uuid())
  name           String
  description    String?
  quantity       Float
  unitPrice      Float
  totalPrice     Float
  unit           String?
  createdAt      DateTime @default(now())  // ← ADICIONE ESTE CAMPO
  updatedAt      DateTime @updatedAt       // ← ADICIONE ESTE CAMPO

  // Relacionamentos
  materialListId String
  materialList   MaterialList @relation(fields: [materialListId], references: [id], onDelete: Cascade)
  materialId     String
  material       Material     @relation(fields: [materialId], references: [id])

  @@map("material_list_items")
}

// Enums
enum BudgetStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum MaterialListStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ServiceUnit {
  UNIT
  METER
}

enum MaterialUnit {
  UNIT
  METER
}

enum DiscountType {
  PERCENTAGE
  FIXED
}